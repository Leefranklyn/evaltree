<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EvalMaster - {{ quiz.title }}</title>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Google Fonts: Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #4caf50;
        --primary-dark: #388e3c;
        --light-bg: #f9fcf9;
        --gray: #6c757d;
        --dark-text: #2c3e50;
      }

      body {
        font-family: "Inter", system-ui, sans-serif;
        background-color: var(--light-bg);
        color: var(--dark-text);
        padding: 2rem 1rem;
      }

      .timer-badge {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
        font-weight: 600;
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      .assessment-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.08);
        padding: 2rem;
        margin-bottom: 2rem;
      }

      .question-number {
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.75rem;
        display: block;
      }

      .option-label {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin: 0.5rem 0;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .option-label:hover {
        background: rgba(76, 175, 80, 0.08);
      }

      .btn-submit {
        background-color: var(--primary);
        border: none;
        border-radius: 50px;
        padding: 0.8rem 2.5rem;
        font-size: 1.1rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .btn-submit:hover:not(:disabled) {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
      }

      .btn-submit:disabled {
        opacity: 0.7;
      }

      @media (max-width: 768px) {
        .assessment-card {
          padding: 1.5rem;
        }
        .timer-badge {
          top: 0.8rem;
          right: 0.8rem;
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Floating Timer -->
    <div class="timer-badge bg-white text-dark" id="timer-badge">
      Time remaining: <span id="timer"></span>
    </div>

    <div class="container">
      <h1 class="text-center mb-5">{{ quiz.title }}</h1>

      <form id="quizForm">
        {% for q in quiz.questions %} {% set q_index = loop.index %}

        <div class="assessment-card">
          <span class="question-number">Question {{ q_index }}</span>
          <p class="lead mb-3">{{ q.text }}</p>

          {% for opt_index in range(q.options|length) %}
          <label class="option-label">
            <input
              type="radio"
              name="q{{ q_index }}"
              value="{{ opt_index }}"
              class="me-3"
              required
            />
            {{ q.options[opt_index] }}
          </label>
          {% endfor %}
        </div>
        {% endfor %}

        <div class="text-center mt-5">
          <button
            type="button"
            id="submitBtn"
            class="btn btn-submit btn-lg px-5"
            onclick="submitQuiz()"
          >
            Submit Assessment
          </button>
        </div>
      </form>
    </div>

    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      let duration = {{ duration }} * 60; // seconds
      const timerElement = document.getElementById('timer');
      const submitBtn = document.getElementById('submitBtn');
      const quizForm = document.getElementById('quizForm');

      function updateTimer() {
          let minutes = Math.floor(duration / 60);
          let seconds = duration % 60;
          timerElement.textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;

          if (duration <= 0) {
              submitQuiz(true); // Auto-submit on time up
              return;
          }

          duration--;
          setTimeout(updateTimer, 1000);
      }

      async function submitQuiz(isAuto = false) {
          if (submitBtn.disabled) return;

          submitBtn.disabled = true;
          submitBtn.textContent = isAuto ? "Time up â€“ Submitting..." : "Submitting...";

          const formData = new FormData(quizForm);

          try {
              const response = await fetch(`/student/submit_quiz/{{ quiz._id }}`, {
                  method: 'POST',
                  body: formData
              });

              if (response.redirected) {
                  window.location.href = response.url;
              } else {
                  throw new Error(`Unexpected response: ${response.status}`);
              }
          } catch (err) {
              alert('Error submitting assessment: ' + err.message);
              submitBtn.disabled = false;
              submitBtn.textContent = "Submit Assessment";
          }
      }

      // Start timer
      updateTimer();
    </script>
  </body>
</html>
